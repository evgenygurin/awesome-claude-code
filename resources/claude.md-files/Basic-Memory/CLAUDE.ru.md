# CLAUDE.md - Руководство по проекту Basic Memory

## Обзор проекта

Basic Memory - это локально-ориентированная система управления знаниями, построенная на Протоколе Контекста Модели (MCP). Она обеспечивает двунаправленную коммуникацию между LLM (такими как Claude) и markdown-файлами, создавая персональный граф знаний, который можно перемещаться по ссылкам между документами.

## РАЗРАБОТКА КОДОВОЙ БАЗЫ

### Информация о проекте

См. файл [README.md](README.md) для обзора проекта.

### Команды сборки и тестирования

- Установка: `just install` или `pip install -e ".[dev]"`
- Запуск тестов: `uv run pytest -p pytest_mock -v` или `just test`
- Один тест: `pytest tests/path/to/test_file.py::test_function_name`
- Линтинг: `just lint` или `ruff check . --fix`
- Проверка типов: `just type-check` или `uv run pyright`
- Форматирование: `just format` или `uv run ruff format .`
- Запуск всех проверок кода: `just check` (запускает lint, format, type-check, test)
- Создание миграции БД: `just migration "Ваше сообщение о миграции"`
- Запуск инспектора MCP для разработки: `just run-inspector`

### Рекомендации по стилю кода

- Длина строки: максимум 100 символов
- Python 3.12+ с полными аннотациями типов
- Форматирование с помощью ruff (согласованный стиль)
- Порядок импорта: стандартная библиотека, сторонние, локальные импорты
- Именование: snake_case для функций/переменных, PascalCase для классов
- Предпочтение асинхронным шаблонам с SQLAlchemy 2.0
- Использование Pydantic v2 для валидации данных и схем
- CLI использует Typer для структуры команд
- API использует FastAPI для конечных точек
- Следование шаблону репозитория для доступа к данным
- Инструменты взаимодействуют с маршрутизаторами api через httpx ASGI клиент (в процессе)
- Избегайте использования "приватных" функций в модулях или классах (с префиксом _)

### Архитектура кодовой базы

- `/alembic` - Миграции БД Alembic
- `/api` - Реализация REST-конечных точек на FastAPI
- `/cli` - Интерфейс командной строки Typer
- `/markdown` - Парсинг и обработка Markdown
- `/mcp` - Реализация сервера Протокола Контекста Модели
- `/models` - SQLAlchemy ORM модели
- `/repository` - Слой доступа к данным
- `/schemas` - Pydantic модели для валидации
- `/services` - Слой бизнес-логики
- `/sync` - Сервисы синхронизации файлов

### Примечания по разработке

- Инструменты MCP определены в src/basic_memory/mcp/tools/
- Промпты MCP определены в src/basic_memory/mcp/prompts/
- Инструменты MCP должны быть атомарными, компонуемыми операциями
- Используйте `textwrap.dedent()` для форматирования многострочных строк в промптах и инструментах
- Промпты MCP используются для вызова инструментов и форматирования контента с инструкциями для LLM
- Изменения схемы требуют миграций Alembic
- SQLite используется для индексации и полнотекстового поиска, файлы являются источником истины
- Тестирование использует pytest с поддержкой asyncio (строгий режим)
- Тестовая база данных использует SQLite в памяти
- Избегайте создания моков в тестах в большинстве случаев
- Каждый тест выполняется в автономной среде с SQLite в памяти и временным каталогом файлов
- По возможности не используйте моки в тестах. Тесты выполняются с базой данных SQLite в памяти, поэтому они не нужны. См. фикстуры в conftest.py

## ИСПОЛЬЗОВАНИЕ ПРОДУКТА BASIC MEMORY

### Структура знаний

- Сущность: Любое понятие, документ или идея, представленные в виде markdown-файла
- Наблюдение: Категоризированный факт о сущности (`- [категория] содержание`)
- Отношение: Направленная связь между сущностями (`- тип_отношения [[Цель]]`)
- Frontmatter: YAML-метаданные в начале markdown-файлов
- Представление знаний следует точному формату markdown:
    - Наблюдения с префиксами [категория]
    - Отношения с WikiLinks [[Сущность]]
    - Frontmatter с метаданными

### Команды Basic Memory

- Синхронизация знаний: `basic-memory sync` или `basic-memory sync --watch`
- Импорт из Claude: `basic-memory import claude conversations`
- Импорт из ChatGPT: `basic-memory import chatgpt`
- Импорт из Memory JSON: `basic-memory import memory-json`
- Проверка статуса синхронизации: `basic-memory status`
- Доступ к инструментам: `basic-memory tools` (предоставляет доступ к инструментам MCP через CLI)
    - Руководство: `basic-memory tools basic-memory-guide`
    - Продолжение: `basic-memory tools continue-conversation --topic="search"`

### Возможности MCP

- Basic Memory предоставляет следующие инструменты MCP для LLM:

  **Управление контентом:**
    - `write_note(title, content, folder, tags)` - Создание/обновление markdown-заметок с семантическими наблюдениями и отношениями
    - `read_note(identifier, page, page_size)` - Чтение заметок по заголовку, постоянной ссылке или URL memory:// с учетом графа знаний
    - `edit_note(identifier, operation, content)` - Инкрементальное редактирование заметок (добавление в конец, добавление в начало, поиск/замена, замена раздела)
    - `move_note(identifier, destination_path)` - Перемещение заметок с сохранением согласованности базы данных и переиндексацией поиска
    - `view_note(identifier)` - Отображение заметок в виде форматированных артефактов для лучшей читаемости в Claude Desktop
    - `read_content(path)` - Чтение необработанного содержимого файла (текст, изображения, бинарные файлы) без обработки графа знаний
    - `delete_note(identifier)` - Удаление заметок из базы знаний

  **Управление проектами:**
    - `list_memory_projects()` - Список всех доступных проектов с индикаторами статуса
    - `switch_project(project_name)` - Переключение на контекст другого проекта во время разговоров
    - `get_current_project()` - Показ текущего активного проекта со статистикой
    - `create_memory_project(name, path, set_default)` - Создание новых проектов Basic Memory
    - `delete_project(name)` - Удаление проектов из конфигурации и базы данных
    - `set_default_project(name)` - Установка проекта по умолчанию в конфигурации
    - `sync_status()` - Проверка статуса синхронизации файлов и фоновых операций

  **Навигация по графу знаний:**
    - `build_context(url, depth, timeframe)` - Навигация по графу знаний через URL-адреса memory:// для непрерывности разговора
    - `recent_activity(type, depth, timeframe)` - Получение недавно обновленной информации с указанным временным интервалом (например, "1d", "1 week")
    - `list_directory(dir_name, depth, file_name_glob)` - Список содержимого каталога с фильтрацией и контролем глубины

  **Поиск и обнаружение:**
    - `search_notes(query, page, page_size)` - Полнотекстовый поиск по всему содержимому с опциями фильтрации

  **Визуализация:**
    - `canvas(nodes, edges, title, folder)` - Генерация файлов холста Obsidian для визуализации графа знаний

- Промпты MCP для лучшего взаимодействия с ИИ:
    - `ai_assistant_guide()` - Руководство по эффективному использованию инструментов Basic Memory для ИИ-ассистентов
    - `continue_conversation(topic, timeframe)` - Продолжение предыдущих разговоров с соответствующим историческим контекстом
    - `search_notes(query, after_date)` - Поиск с подробными, форматированными результатами для лучшего понимания контекста
    - `recent_activity(timeframe)` - Просмотр недавно измененных элементов с форматированным выводом
    - `json_canvas_spec()` - Полная спецификация JSON Canvas для визуализации Obsidian

## Совместная разработка ИИ-человек

Basic Memory возник из и обеспечивает новый вид процесса разработки, который объединяет возможности человека и ИИ. Вместо использования ИИ только для генерации кода, мы разработали настоящий совместный рабочий процесс:

1. ИИ (LLM) пишет начальную реализацию на основе спецификаций и контекста
2. Человек проверяет, запускает тесты и коммитит код с необходимыми корректировками
3. Знания сохраняются между разговорами с использованием графа знаний Basic Memory
4. Разработка продолжается беспрепятственно в разных сессиях ИИ с согласованным контекстом
5. Результаты улучшаются благодаря итеративному сотрудничеству и общему пониманию

Этот подход позволил нам решать более сложные задачи и создать более надежную систему, чем могли бы достичь люди или ИИ независимо друг от друга.

## Интеграция с GitHub

Basic Memory использует Claude непосредственно в рабочем процессе разработки через GitHub:

### Инструменты GitHub MCP

Используя сервер Протокола Контекста Модели GitHub, Claude может:

- **Управление репозиторием**:
    - Просматривать файлы и структуру репозитория
    - Читать содержимое файлов
    - Создавать новые ветки
    - Создавать и обновлять файлы

- **Управление задачами**:
    - Создавать новые задачи
    - Комментировать существующие задачи
    - Закрывать и обновлять задачи
    - Искать по задачам

- **Рабочий процесс с запросами на слияние**:
    - Создавать запросы на слияние
    - Проверять изменения кода
    - Добавлять комментарии к PR

Эта интеграция позволяет Claude участвовать в качестве полноценного члена команды в процессе разработки, а не просто как инструмент для генерации кода. Учетная запись Claude на GitHub ([bm-claudeai]([ссылка на GitHub аккаунт Claude])) является членом организации Basic Machines с прямым доступом к кодовой базе.

### Процесс совместной разработки

С интеграцией GitHub рабочий процесс разработки включает:

1. **Прямой обзор кода** - Claude может анализировать PR и предоставлять подробную обратную связь
2. **Отслеживание вклада** - Все вклады Claude правильно атрибутируются в истории Git
3. **Управление ветками** - Claude может создавать ветки функций для реализаций
4. **Поддержка документации** - Claude может поддерживать документацию в актуальном состоянии по мере развития кода

С этой интеграцией ИИ-ассистент является полноценным членом команды, а не просто инструментом для генерации фрагментов кода.

### Basic Memory Pro

Basic Memory Pro - это настольное GUI-приложение, которое оборачивает инструменты CLI/MCP basic-memory:

- Построено с использованием Tauri (Rust), React (TypeScript) и Python FastAPI в качестве сайдкара
- Предоставляет визуальное исследование графа знаний и управление проектами
- Использует ту же основную кодовую базу, но добавляет интерфейс, удобный для настольных компьютеров
- Конфигурация проекта общая между версиями CLI и Pro
- Поддержка нескольких проектов с визуальным интерфейсом переключения

локальный репозиторий: [путь к локальному репозиторию]
github: [ссылка на репозиторий GitHub]

## Управление релизами и версиями

Basic Memory использует `uv-dynamic-versioning` для автоматического управления версиями на основе тегов git:

### Типы версий
- **Версии разработки**: Автоматически генерируются из коммитов (например, `0.12.4.dev26+468a22f`)
- **Бета-релизы**: Создаются путем тегирования с суффиксами бета (например, `v0.13.0b1`, `v0.13.0rc1`)
- **Стабильные релизы**: Создаются путем тегирования с номерами версий (например, `v0.13.0`)

### Рабочие процессы релизов

#### Сборки разработки (автоматические)
- Запускаются при каждом пуше в ветку `main`
- Публикуют версии разработки, такие как `0.12.4.dev26+468a22f`, в PyPI
- Позволяют непрерывно тестировать последние изменения
- Пользователи устанавливают с помощью: `pip install basic-memory --pre --force-reinstall`

#### Бета/RC релизы (ручные)
- Создание бета-тега: `git tag v0.13.0b1 && git push origin v0.13.0b1`
- Автоматически собирается и публикуется в PyPI как предварительный релиз
- Пользователи устанавливают с помощью: `pip install basic-memory --pre`
- Используется для тестирования вех перед стабильным релизом

#### Стабильные релизы (автоматизированные)
- Используйте автоматизированную систему релизов: `just release v0.13.0`
- Включает комплексные проверки качества (lint, format, type-check, tests)
- Автоматически обновляет версию в `__init__.py`
- Создает тег git и пушит в GitHub
- Запускает рабочий процесс GitHub Actions для:
  - Публикации в PyPI
  - Обновления формулы Homebrew (требуется секрет HOMEBREW_TOKEN)

**Ручной метод (устаревший):**
- Создание тега версии: `git tag v0.13.0 && git push origin v0.13.0`

#### Обновления формулы Homebrew
- Автоматически запускаются после успешного релиза в PyPI **только для стабильных релизов**
- **Стабильные релизы** (например, v0.13.7) автоматически обновляют основную формулу `basic-memory`
- **Предварительные релизы** (dev/beta/rc) НЕ обновляются автоматически - пользователи должны указывать версию вручную
- Обновляет формулу в репозитории `basicmachines-co/homebrew-basic-memory`
- Требуется секрет `HOMEBREW_TOKEN` в настройках репозитория GitHub:
  - Создайте точно настроенный Personal Access Token с областями `Contents: Read and Write` и `Actions: Read` для `basicmachines-co/homebrew-basic-memory`
  - Добавьте как секрет репозитория с именем `HOMEBREW_TOKEN` в `basicmachines-co/basic-memory`
- Обновления формулы включают новый URL версии и контрольную сумму SHA256

### Для разработки
- **Автоматизированные релизы**: Используйте `just release v0.13.x` для стабильных релизов и `just beta v0.13.0b1` для бета-релизов
- **Ворота качества**: Все релизы требуют прохождения lint, format, type-check и тестовых наборов
- **Управление версиями**: Версии автоматически выводятся из тегов git через `uv-dynamic-versioning`
- **Конфигурация**: `pyproject.toml` использует `dynamic = ["version"]`
- **Автоматизация релизов**: `__init__.py` обновляется автоматически во время процесса релиза
- **CI/CD**: GitHub Actions обрабатывает сборку и публикацию в PyPI

## Примечания по разработке
- убедитесь, что вы подписываете коммиты

