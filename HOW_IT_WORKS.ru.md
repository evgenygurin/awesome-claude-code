# Как работает Awesome Claude Code

Этот документ предоставляет технические детали о структуре репозитория, автоматизированных системах и процессах, которые обеспечивают работу Awesome Claude Code.

## Архитектура репозитория

### Основные файлы

- **`THE_RESOURCES_TABLE.csv`** - Единственный источник истины для всех ресурсов
- **`README.md`** - Генерируется автоматически из CSV и шаблонов
- **`templates/`** - Содержит шаблоны для генерации README
  - `README.template.md` - Основная структура шаблона
  - `categories.yaml` - Единственный источник истины для всех категорий
  - `resource-overrides.yaml` - Ручные переопределения для конкретных ресурсов

### Директория скриптов

Директория `scripts/` содержит всю автоматизацию:

- **`parse_issue_form.py`** - Анализирует отправки форм GitHub
- **`create_resource_pr.py`** - Создает PR из одобренных заявок
- **`generate_readme.py`** - Генерирует README из данных CSV
- **`validate_single_resource.py`** - Проверяет отдельные ресурсы
- **`validate_links.py`** - Массовая проверка всех ресурсов
- **`badge_issue_notification.py`** - Создает уведомления в представленных репозиториях
- **`quick_id.py`** - Генерирует уникальные идентификаторы ресурсов

### Рабочие процессы GitHub Actions

Расположены в `.github/workflows/`:

- **`validate-resource-submission.yml`** - Запускается при создании/редактировании задачи
- **`approve-resource-submission.yml`** - Запускается по командам сопровождающего
- **`protect-labels.yml`** - Предотвращает несанкционированные изменения меток
- **`validate-links.yml`** - Запланированная проверка всех ссылок на ресурсы
- **Дополнительные рабочие процессы для CI/CD и обслуживания**

### Метки GitHub

Система подачи использует несколько меток для отслеживания состояния задачи:

#### Метки подачи ресурсов

- **`resource-submission`** - Применяется автоматически к задачам, созданным через форму подачи
- **`validation-passed`** - Применяется, когда заявка проходит все проверки валидации
- **`validation-failed`** - Применяется, когда заявка не проходит валидацию
- **`approved`** - Применяется, когда сопровождающий одобряет заявку с помощью `/approve`
- **`pr-created`** - Применяется после успешного создания PR
- **`error-creating-pr`** - Применяется, если создание PR не удалось
- **`rejected`** - Применяется, когда сопровождающий отклоняет с помощью `/reject`
- **`changes-requested`** - Применяется, когда сопровождающий запрашивает изменения с помощью `/request-changes`

#### Другие метки

- **`broken-links`** - Применяется запланированной проверкой ссылок, когда ресурсы становятся недоступными
- **`automated`** - Применяется вместе с `broken-links` для обозначения автоматического обнаружения

#### Защита меток

Все метки, связанные с подачей, защищены от несанкционированных изменений. Рабочий процесс `protect-labels.yml` автоматически отменяет любые изменения меток, сделанные не-сопровождающими (пользователями без разрешений OWNER, MEMBER или COLLABORATOR).

#### Переходы состояний меток

1. Новая заявка → `resource-submission`
2. После валидации → добавляет `validation-passed` ИЛИ `validation-failed`
3. Если запрошены изменения → добавляет `changes-requested`
4. Когда пользователь редактирует и валидация проходит → удаляет `changes-requested`
5. При одобрении → добавляет `approved` + `pr-created` (или `error-creating-pr`)
6. При отклонении → добавляет `rejected`

## Процесс подачи

### 1. Пользователь отправляет задачу

Когда пользователь отправляет ресурс через форму задачи:

```yaml
# .github/ISSUE_TEMPLATE/submit-resource.yml
- Структурированная форма со всеми обязательными полями
- Автоматическая метка "resource-submission"
- Проверяет форматы ввода
```

### 2. Автоматическая валидация

Процесс валидации запускается немедленно:

```python
# Упрощенный процесс валидации
1. Анализ тела задачи → извлечение данных формы
2. Проверка обязательных полей
3. Проверка доступности URL
4. Проверка отсутствия дубликатов
5. Публикация результатов в комментарии
6. Обновление меток задачи
```

**Валидация включает:**
- Проверку URL (ответ 200 OK)
- Обнаружение лицензии из API GitHub
- Проверку дубликатов в существующем CSV
- Проверку формата полей

### 3. Проверка сопровождающим

После прохождения валидации сопровождающие могут:

- `/approve` - Запускает создание PR
- `/request-changes [причина]` - Запрашивает изменения
- `/reject [причина]` - Закрывает заявку

**Система уведомлений:**
- Когда запрашиваются изменения, сопровождающий @-упоминается в комментарии
- Когда пользователь редактирует свою задачу, сопровождающий получает уведомление, если:
  - Это первое редактирование после запроса изменений
  - Статус валидации изменяется (прошел→не прошел или не прошел→прошел)
- Многократные быстрые редактирования не будут спамить сопровождающего уведомлениями

### 4. Автоматическое создание PR

После одобрения:

```bash
1. Проверка свежей ветки main
2. Создание уникальной ветки: add-resource/category/name-timestamp
3. Добавление ресурса в CSV с сгенерированным ID
4. Запуск generate_readme.py
5. Коммит изменений
6. Отправка ветки
7. Создание PR через GitHub CLI
8. Связывание с исходной задачей
9. Закрытие задачи подачи
```

### 5. Заключительные шаги

- Сопровождающий объединяет PR
- Запускается система уведомлений о значках (если включена)
- Отправитель получает уведомления GitHub

## Генерация ID ресурсов

ID следуют формату: `{prefix}-{hash}`

```python
prefixes = {
    "Slash-Commands": "cmd",
    "Workflows & Knowledge Guides": "wf",
    "Tooling": "tool",
    "CLAUDE.md Files": "claude",
    "Hooks": "hook",
    "Official Documentation": "doc",
}

# Хэш - первые 8 символов SHA256(display_name + primary_link)
```

## Структура CSV

| Поле | Описание | Обязательно | Автозаполнение |
|-------|-------------|----------|----------------|
| ID | Уникальный идентификатор | Да | Да |
| Display Name | Название ресурса | Да | Нет |
| Category | Основная категория | Да | Нет |
| Sub-Category | Опциональная подкатегория | Нет | Нет |
| Primary Link | Основной URL | Да | Нет |
| Secondary Link | Дополнительный URL | Нет | Нет |
| Author Name | Имя создателя | Да | Нет |
| Author Link | Профиль создателя | Да | Нет |
| Active | Статус TRUE/FALSE | Да | Да (через валидацию) |
| Date Added | Дата добавления | Нет | Да |
| Last Modified | Последний коммит GitHub | Нет | Да (из API) |
| Last Checked | Временная метка валидации | Да | Да |
| License | Идентификатор SPDX | Рекомендуется | Да (из GitHub) |
| Description | Краткое описание | Да | Нет |

## Генерация README

README генерируется из шаблонов с использованием:

```yaml
# templates/categories.yaml
categories:
  - id: workflows
    name: "Workflows & Knowledge Guides"
    prefix: wf
    icon: "🧠"
    order: 1
    
  - id: statusline
    name: "Statusline"
    prefix: status
    icon: "📊"
    order: 3
```

Процесс генерации:
1. Загрузка данных CSV
2. Применение любых переопределений из `resource-overrides.yaml`
3. Группировка по категории/подкатегории
4. Форматирование с использованием шаблонов
5. Запись финального README

## Система валидации

### Валидация ссылок

- Проверяет HTTP-статус (200-299 = действительный)
- Обрабатывает перенаправления
- Соблюдает ограничения скорости
- Кэширует результаты для эффективности

### Специфичные для GitHub функции

Для ссылок GitHub:
- Получает метаданные репозитория
- Извлекает информацию о лицензии
- Получает дату последнего коммита
- Проверяет, существует ли репозиторий/является ли он публичным

### Система переопределений

`templates/resource-overrides.yaml` позволяет:
- Блокировать определенные поля от обновлений
- Пропускать валидацию для особых случаев
- Вручную корректировать автоматически обнаруженные данные

## Соображения безопасности

1. **Валидация ввода** - Весь пользовательский ввод санитизируется
2. **Валидация URL** - Принимаются только URL с HTTPS
3. **Область действия токена GitHub** - Требуются минимальные разрешения
4. **Процесс проверки** - Человеческая проверка перед изменениями кода
5. **Автоматические проверки** - Нет прямого манипулирования CSV пользователями

## Переменные окружения

- `GITHUB_TOKEN` - Для доступа к API (предоставляется Actions)
- `AWESOME_CC_PAT_PUBLIC_REPO` - Для создания уведомлений
- `CREATE_ISSUES` - Включение/отключение системы уведомлений

## Локальная разработка

Для тестирования локально:

```bash
# Установка зависимостей
pip install -r requirements.txt

# Тестирование валидации
python scripts/validate_single_resource.py "https://example.com"

# Генерация README
python scripts/generate_readme.py

# Анализ тестовой задачи
ISSUE_BODY="..." python scripts/parse_issue_form.py --validate
```

## Задачи обслуживания

### Регулярные задачи

- Мониторинг сбоев валидации
- Обновление шаблонов по мере необходимости
- Проверка и объединение PR
- Обработка особых случаев с переопределениями

### Массовые операции

```bash
# Валидация всех ссылок
make validate

# Сортировка ресурсов
make sort

# Регенерация README
make generate
```

## Вклад в систему

Для улучшения автоматизации:

1. Сначала протестируйте изменения локально
2. Обновите соответствующую документацию
3. Учитывайте обратную совместимость
4. Добавьте тесты, если применимо
5. Отправьте PR с четким описанием

---

Для вопросов о технической реализации, пожалуйста, откройте задачу с меткой "enhancement".
2. **Валидация URL** - Принимаются только URL с HTTPS
3. **Область действия токена GitHub** - Требуются минимальные разрешения
4. **Процесс проверки** - Человеческая проверка перед изменениями кода
5. **Автоматические проверки** - Нет прямого манипулирования CSV пользователями

## Переменные окружения

- `GITHUB_TOKEN` - Для доступа к API (предоставляется Actions)
- `AWESOME_CC_PAT_PUBLIC_REPO` - Для создания уведомлений
- `CREATE_ISSUES` - Включение/отключение системы уведомлений

## Локальная разработка

Для тестирования локально:

```bash
# Установка зависимостей
pip install -r requirements.txt

# Тестирование валидации
python scripts/validate_single_resource.py "https://example.com"

# Генерация README
python scripts/generate_readme.py

# Анализ тестовой задачи
ISSUE_BODY="..." python scripts/parse_issue_form.py --validate
```

## Задачи обслуживания

### Регулярные задачи

- Мониторинг сбоев валидации
- Обновление шаблонов по мере необходимости
- Проверка и объединение PR
- Обработка особых случаев с переопределениями

### Массовые операции

```bash
# Валидация всех ссылок
make validate

# Сортировка ресурсов
make sort

# Регенерация README
make generate
```

## Вклад в систему

Для улучшения автоматизации:

1. Сначала протестируйте изменения локально
2. Обновите соответствующую документацию
3. Учитывайте обратную совместимость
4. Добавьте тесты, если применимо
5. Отправьте PR с четким описанием

---

Для вопросов о технической реализации, пожалуйста, откройте задачу с меткой "enhancement".
